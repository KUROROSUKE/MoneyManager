<!DOCTYPE html>
<html>
<head>
  <title>é€é‡‘ï¼ˆé¸æŠå¼ãƒ»å®‰å®šç‰ˆï¼‹ãƒ©ãƒ³ãƒ€ãƒ åå‰ï¼‹ä¸€è¦§è¡¨ç¤ºï¼‹å¹³å‡æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ è»½é‡ç‰ˆï¼‰</title>
  <meta charset="UTF-8" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ğŸ’¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“é€é‡‘ï¼ˆãƒ©ãƒ³ãƒ€ãƒ åï¼‹å¹³å‡æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ è»½é‡ç‰ˆï¼‰</h1>

  <button onclick="login()">ğŸ”‘ Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <h3>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³</h3>
<div>
  <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" /><br>
  <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" /><br>
  <button onclick="loginWithEmail()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  <button onclick="registerWithEmail()">æ–°è¦ç™»éŒ²</button>
  <div id="emailMessage"></div>
</div>

  <button onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  <div id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</div>

  <hr>

  <div id="nameEditSection" style="display:none;">
    <label>è¡¨ç¤ºåã‚’å¤‰æ›´ï¼š</label><br>
    <input type="text" id="nameInput" />
    <button onclick="updateName()">åå‰ã‚’ä¿å­˜</button>
    <div id="nameMessage"></div>
  </div>

  <hr>

  <form onsubmit="handleTransfer(event)">
    <label>é€é‡‘å…ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š</label><br>
    <select id="receiverSelect" required>
      <option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>
    </select><br><br>

    <label>é‡‘é¡ï¼š</label><br>
    <input type="number" id="amount" required><br><br>

    <button type="submit">é€é‡‘ã™ã‚‹</button>
  </form>

  <div id="message"></div>

  <hr>
  <h2>ğŸ“Š ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è³‡é‡‘ä¸€è¦§</h2>
  <table id="userBalanceTable" border="1" cellpadding="5">
    <thead>
      <tr>
        <th>åå‰</th>
        <th>æ®‹é«˜ (Eed)</th>
      </tr>
    </thead>
    <tbody id="userBalanceList"></tbody>
  </table>

  <hr>
  <p id="MyStocks"></p>
  <p id="StockAverage"></p>

  <div>
    <label>æ ªå¼ï¼š</label><br>
    <select id="UsersStock" required>
      <option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>
    </select><br><br>

    <label>ç¾åœ¨æ ªæ•°ï¼š</label><br>
    <p id="UsersStockAmount"></p>

    <label>å£²è²·æ ªæ•°ï¼š</label><br>
    <input type="number" id="StockAmount" required><br><br>

    <button id="BuyStock">è³¼å…¥ã™ã‚‹</button>
    <button id="SellStock">å£²å´ã™ã‚‹</button>

    <div id="StockMessage"></div>
  </div>

  <hr>
  <h2>ğŸ“ˆ å¹³å‡æ ªä¾¡ã®æ¨ç§»</h2>
  <canvas id="averageStockChart" width="400" height="200"></canvas>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyC_8ZxABdbxPH8lQGBPuCuZZIk_hLKi6OI",
  authDomain: "moneymanager-a0e97.firebaseapp.com",
  databaseURL: "https://moneymanager-a0e97-default-rtdb.firebaseio.com",
  projectId: "moneymanager-a0e97",
  storageBucket: "moneymanager-a0e97.appspot.com",
  messagingSenderId: "649411038344",
  appId: "1:649411038344:web:bacd8a5c7a743e6edf633d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let chartInstance = null;

const nameInput = document.getElementById("nameInput");
const nameEditSection = document.getElementById("nameEditSection");
const nameMessage = document.getElementById("nameMessage");
const userBalanceList = document.getElementById("userBalanceList");

function getRandomName() {
  const animals = ["neko", "inu", "tori", "kuma", "saru", "kitsune", "tanuki", "shika", "tako", "penguin"];
  const rand = animals[Math.floor(Math.random() * animals.length)] + Math.floor(Math.random() * 1000);
  return rand;
}

async function getAllNames() {
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val();
  return users ? Object.values(users).map(u => u.name) : [];
}

async function generateUniqueName() {
  const existingNames = await getAllNames();
  let name;
  do {
    name = getRandomName();
  } while (existingNames.includes(name));
  return name;
}

function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(error => {
  alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + error.message);
  });
}

function logout() {
  auth.signOut();
}

auth.onAuthStateChanged(async user => {
  const userInfo = document.getElementById("userInfo");
  if (user) {
    currentUser = user;
    userInfo.innerHTML = `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š${user.displayName}ï¼ˆUID: ${user.uid}ï¼‰`;

    const userRef = db.ref("users/" + user.uid);
    const snapshot = await userRef.once("value");
    const val = snapshot.val();

    if (!val || val.balance == null) {
      const uniqueName = await generateUniqueName();
      await userRef.set({
      name: uniqueName,
      balance: 1000,
      stock: 0,
      price: 100
      });
      nameInput.value = uniqueName;
    } else {
      nameInput.value = val.name || "";
    }

    loadUsers();
    nameEditSection.style.display = "block";
  } else {
    currentUser = null;
    userInfo.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚";
    document.getElementById("receiverSelect").innerHTML = '<option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>';
    nameEditSection.style.display = "none";
  }
});

async function updateName() {
  const newName = nameInput.value.trim();
  if (!newName) {
    nameMessage.textContent = "âŒ ç©ºã®åå‰ã¯ä½¿ãˆã¾ã›ã‚“";
    return;
  }

  const existingNames = await getAllNames();
  if (existingNames.includes(newName)) {
    nameMessage.textContent = "âŒ ã“ã®åå‰ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™";
    return;
  }

  const userRef = db.ref("users/" + currentUser.uid);
  userRef.update({ name: newName })
  .then(() => {
    nameMessage.textContent = "âœ… åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
    loadUsers();
  })
  .catch(error => {
    nameMessage.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ï¼š" + error.message;
  });
}

function loadUsers() {
  const select = document.getElementById("receiverSelect");
  const StockSelect = document.getElementById("UsersStock");
  const userBalanceList = document.getElementById("userBalanceList");
  const MyStocks = document.getElementById("MyStocks");

  db.ref("users").on("value", (snapshot) => {
    const users = snapshot.val();

    if (users && currentUser) {
      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªã‚»ãƒƒãƒˆ
      userBalanceList.innerHTML = '';
      select.innerHTML = '<option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>';
      StockSelect.innerHTML = '<option value="">-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ --</option>';
      
      let AllStockAmounts = 0;
      let usersNum = 0;

      Object.entries(users).forEach(([uid, data]) => {
        // é€é‡‘å…ˆãƒ»æ ªå¼ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®æ›´æ–°
        if (uid !== currentUser.uid) {
          const option = document.createElement("option");
          option.value = uid;
          option.textContent = `${data.name}ï¼ˆæ®‹é«˜ï¼š${data.balance} Eedï¼‰`;
          select.appendChild(option);

          const option2 = document.createElement("option");
          option2.value = uid;
          option2.textContent = `${data.name}ï¼ˆæ ªä¾¡ï¼š${data.price ?? 0} Eedï¼‰`;
          StockSelect.appendChild(option2);

          AllStockAmounts += data.price;
          usersNum += 1;
          
        } else {
          MyStocks.innerHTML = `è‡ªåˆ†ã®æ ªä¾¡ï¼š${data.price}`;
          AllStockAmounts += data.price;
          usersNum += 1;
        }

        // è³‡é‡‘ä¸€è¦§ï¼ˆè¡¨å½¢å¼ï¼‰
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdBalance = document.createElement("td");

        tdName.textContent = data.name;
        tdBalance.textContent = `${data.balance ?? 0} Eed`;

        tr.appendChild(tdName);
        tr.appendChild(tdBalance);
        userBalanceList.appendChild(tr);
      });

      let AllUsersStockAverage = AllStockAmounts / usersNum;
      document.getElementById("StockAverage").innerHTML = `å¹³å‡æ ªä¾¡ï¼š${AllUsersStockAverage}`;
    }
  }, (error) => {
    console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
  });
}

function handleTransfer(event) {
  event.preventDefault();

  const toUid = document.getElementById("receiverSelect").value;
  const amount = parseInt(document.getElementById("amount").value, 10);
  const message = document.getElementById("message");
  message.textContent = "";

  if (!currentUser) {
  alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼");
  return;
  }

  if (!toUid || isNaN(amount) || amount <= 0) {
  alert("æœ‰åŠ¹ãªé€é‡‘å…ˆã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  return;
  }

  const fromUid = currentUser.uid;
  const fromRef = db.ref("users/" + fromUid);
  const toRef = db.ref("users/" + toUid);

  fromRef.once("value").then((snapshot) => {
    const fromData = snapshot.val();

    if (!fromData || typeof fromData.balance !== "number") {
      message.textContent = "âŒ è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      return;
    }

    if (fromData.balance < amount) {
      message.textContent = "âŒ æ®‹é«˜ä¸è¶³ã§ã™";
      return;
    }

    fromRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance -= amount;
      return current;
    }).then(result => {
      if (!result.committed) {
      message.textContent = "âŒ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­æ­¢ï¼ˆè‡ªåˆ†ï¼‰";
      return;
      }

      toRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance += amount;
      return current;
      }).then(toResult => {
      if (!toResult.committed) {
          message.textContent = "âš ï¸ ç›¸æ‰‹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¸­æ­¢ï¼ˆãƒªãƒˆãƒ©ã‚¤æ¨å¥¨ï¼‰";
          return;
      }

      message.textContent = "âœ… é€é‡‘æˆåŠŸï¼";
      loadUsers();
      });
    });
  }).catch(error => {
    message.textContent = "âŒ å‡¦ç†ä¸­ã‚¨ãƒ©ãƒ¼ï¼š" + error.message;
  });
}

document.getElementById("BuyStock").addEventListener("click", async function () {
  const button = document.getElementById("BuyStock");
  button.disabled = true;

  const StockAmount = parseInt(document.getElementById("StockAmount").value, 10);
  const toUid = document.getElementById("UsersStock").value;
  const fromUid = currentUser?.uid;
  const message = document.getElementById("StockMessage");

  if (!currentUser) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼"); button.disabled = false; return; }
  if (!toUid || isNaN(StockAmount) || StockAmount <= 0) { alert("æœ‰åŠ¹ãªé€é‡‘å…ˆã¨æ ªæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); button.disabled = false; return; }

  const fromRef = db.ref("users/" + fromUid);
  const toRef   = db.ref("users/" + toUid);

  try {
    const stockSnapshot = await toRef.once("value");
    const stockPrice = stockSnapshot.val()?.price;

    if (typeof stockPrice !== "number" || isNaN(stockPrice)) {
      message.textContent = "âŒ æ ªä¾¡ãŒç„¡åŠ¹ã§ã™";
      button.disabled = false;
      return;
    }

    const fromSnapshot = await fromRef.once("value");
    const fromData = fromSnapshot.val();

    if (!fromData || typeof fromData.balance !== "number") {
      message.textContent = "âŒ è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      button.disabled = false;
      return;
    }

    let totalPrice = StockAmount * stockPrice;
    if (fromData.balance < totalPrice) {
      message.textContent = "âŒ æ®‹é«˜ä¸è¶³ã§ã™";
      button.disabled = false;
      return;
    }

    await toRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance += totalPrice;
      current.price += StockAmount-1;
      totalPrice = StockAmount * current.price;
      return current;
    });

    await fromRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance -= totalPrice;
      current[toUid] = (current[toUid] || 0) + StockAmount;
      return current;
    });

    message.textContent = "âœ… æ ªè³¼å…¥æˆåŠŸï¼";
    loadUsers();
    await saveAverageStockHistory();
  } catch (error) {
    message.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ï¼š" + error.message;
  }

  button.disabled = false;
});

document.getElementById("SellStock").addEventListener("click", async function () {
  const button = document.getElementById("SellStock");
  button.disabled = true;

  const StockAmount = parseInt(document.getElementById("StockAmount").value, 10);
  const toUid = document.getElementById("UsersStock").value;
  const fromUid = currentUser?.uid;
  const message = document.getElementById("StockMessage");

  if (!currentUser) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼"); button.disabled = false; return; }
  if (!toUid || isNaN(StockAmount) || StockAmount <= 0) { alert("æœ‰åŠ¹ãªé€é‡‘å…ˆã¨æ ªæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); button.disabled = false; return; }

  const fromRef = db.ref("users/" + fromUid);
  const toRef = db.ref("users/" + toUid);

  try {
    const stockSnapshot = await toRef.once("value");
    let stockPrice = stockSnapshot.val()?.price;

    if (typeof stockPrice !== "number" || isNaN(stockPrice)) {
      message.textContent = "âŒ æ ªä¾¡ãŒç„¡åŠ¹ã§ã™";
      button.disabled = false;
      return;
    }

    const fromSnapshot = await fromRef.once("value");
    const fromData = fromSnapshot.val();

    const ownedStocks = fromData?.[toUid] || 0;
    if (ownedStocks < StockAmount) {
      message.textContent = "âŒ æ ªæ•°ä¸è¶³ã§ã™";
      button.disabled = false;
      return;
    }

    await toRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance -= StockAmount * stockPrice;
      current.price -= StockAmount-1;
      stockPrice = current.price;
      return current;
    });

    await fromRef.transaction(current => {
      if (!current || typeof current.balance !== "number") return current;
      current.balance += StockAmount * stockPrice;
      current[toUid] -= StockAmount;
      return current;
    });

    message.textContent = "âœ… æ ªå£²å´æˆåŠŸï¼";
    loadUsers();
    await saveAverageStockHistory();
  } catch (error) {
    message.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ï¼š" + error.message;
  }

  button.disabled = false;
});

document.getElementById("UsersStock").addEventListener("change", async function() {
  const toUid = document.getElementById("UsersStock").value;
  const fromUid = currentUser?.uid;
  const display = document.getElementById("UsersStockAmount");

  if (!currentUser) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼");
    display.textContent = "";
    return;
  }

  if (!toUid) {
    display.textContent = "";
    return;
  }

  const fromRef = db.ref("users/" + fromUid);

  try {
    const snapshot = await fromRef.once("value");
    const fromData = snapshot.val();
    const stockCount = fromData?.[toUid] || 0;

    display.textContent = `${stockCount} æš`;
  } catch (error) {
    console.error("æ ªæ•°ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    display.textContent = "âŒ ã‚¨ãƒ©ãƒ¼";
  }
});

function loginWithEmail() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const message = document.getElementById("emailMessage");
  message.textContent = "";

  if (!email || !password) {
    message.textContent = "âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
  .catch(error => {
    message.textContent = "âŒ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ï¼š" + error.message;
  });
}

function registerWithEmail() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const message = document.getElementById("emailMessage");
  message.textContent = "";

  if (!email || !password) {
    message.textContent = "âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
  .catch(error => {
    message.textContent = "âŒ ç™»éŒ²å¤±æ•—ï¼š" + error.message;
  });
}

async function saveAverageStockHistory() {
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val();
  if (!users) return;
  let totalPrice = 0;
  let count = 0;
  Object.values(users).forEach(u => {
    if (typeof u.price === "number") {
      totalPrice += u.price;
      count++;
    }
  });
  if (count === 0) return;
  const average = totalPrice / count;
  const timestamp = Date.now();
  await db.ref("stock_history/" + timestamp).set({ average_price: average });
  drawAverageStockChart();
}

// è»½é‡ç‰ˆãƒãƒ£ãƒ¼ãƒˆæç”»
async function drawAverageStockChart() {
  const snapshot = await db.ref("stock_history").orderByKey().limitToLast(500).once("value");
  const data = snapshot.val();
  if (!data) return;
  const timestamps = Object.keys(data).sort();
  const averages = timestamps.map(ts => data[ts].average_price);
  const labels = timestamps.map(ts => new Date(parseInt(ts)).toLocaleString());
  const ctx = document.getElementById('averageStockChart').getContext('2d');

  if (chartInstance) {
    chartInstance.data.labels = labels;
    chartInstance.data.datasets[0].data = averages;
    chartInstance.update();
  } else {
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{ label: 'å¹³å‡æ ªä¾¡', data: averages, borderColor: 'blue', fill: false }]
      },
      options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: true } } }
    });
  }
}

window.onload = drawAverageStockChart;
  </script>
</body>
</html>
